user www-data www-data;
error_log /usr/local/nginx/logs/error.log;
worker_processes 2;
pid /usr/local/nginx/logs/nginx.pid;

load_module /usr/local/nginx/modules/ngx_http_brotli_filter_module.so;
load_module /usr/local/nginx/modules/ngx_http_brotli_static_module.so;

events {
    worker_connections 512;
    use epoll;
}

http {
    fastcgi_cache_path /var/cache/nginx/fastcgi_cache levels=1:2 keys_zone=FASTCGI_CACHE:10m inactive=60m use_temp_path=off;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$request_time"';

    include       mime.types;
    default_type  application/octet-stream;
    access_log    /usr/local/nginx/logs/access.log main;
    charset       utf-8;

    include /usr/local/nginx/conf/restrictions/rate-limit.conf;
    include /usr/local/nginx/conf/global/ssl.conf;
    include /usr/local/nginx/conf/global/gzip.conf;
    include /usr/local/nginx/conf/global/security_headers.conf;

    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;

    keepalive_timeout 75 20;
    lingering_time    15;

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
		ssl_certificate /etc/letsencrypt/live/klarerkopf-augsburg.de/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/klarerkopf-augsburg.de/privkey.pem;
        server_name klarerkopf-augsburg.de www.klarerkopf-augsburg.de;;
        root /var/www/html;

        index index.php index.html;
        include /usr/local/nginx/conf/cache/browser-cache.conf;

        location ~ /\. {
            deny all;
        }

        location = /wp-login.php {
            limit_req zone=one burst=2 nodelay;
            include /usr/local/nginx/conf/snippets/fastcgi-php.conf;
        }

        location /wp-admin {
            allow 185.238.219.0/24;
            allow 2.209.251.219;
            allow 172.18.112.1;
            allow 192.168.2.1;
            allow 192.168.178.51;
            allow 192.168.186.1;
            deny all;
            include /usr/local/nginx/conf/snippets/fastcgi-php.conf;
        }

        location ~ \.php$ {
	    limit_req zone=one burst=2 nodelay;
            include /usr/local/nginx/conf/snippets/fastcgi-php.conf;
            include /usr/local/nginx/conf/cache/fastcgi-cache.conf;
        }

        location / {
	    limit_req zone=two burst=2 nodelay;
            try_files $uri $uri/ /index.php?$args;
        }
    }
	server {
    listen 80;
    listen [::]:80;
    server_name klarerkopf-augsburg.de www.klarerkopf-augsburg.de;
    return 301 https://$host$request_uri;
	}
}

